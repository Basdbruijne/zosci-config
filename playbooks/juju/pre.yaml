- hosts: all
  tasks:
    - name: hack around juju's reluctance to deploy misnamed directories
      copy:
        src: "/home/ubuntu/{{ zuul.project.src_dir }}/"
        dest: "/home/ubuntu/{{ zuul.project.src_dir | replace('charm-', '') }}"
        remote_src: yes
    - name: 'install crashdump'
      become: true
      snap:
        name: juju-crashdump
        classic: yes
    # setup networking
    - name: get ip
      shell: ip a | grep 10.5 | awk '{print $2}' | awk -F '/' '{print $1}'
      args:
        executable: /bin/bash
      register: ip_out
    - name: set test VIP CIDR
      set_fact:
        cidr_ext=172.16.{{ ip_out.stdout.split('.')[-1]}}.0/24
        network=172.16.{{ ip_out.stdout.split('.')[-1]}}.
    # Setup Juju
    - name: 'install juju'
      become: true
      snap:
        name: juju
        classic: yes
    - name: Render juju clouds.yaml
      template:
        src: clouds.yaml.j2
        dest: clouds.yaml
    - name: Add cloud
      command: /snap/bin/juju add-cloud --client {{ serverstack_cloud.region_name }} clouds.yaml
    - name: 'render credentials.yaml'
      template:
        src: credentials.yaml.j2
        dest: credentials.yaml
    - name: Add credential
      command: /snap/bin/juju add-credential {{ serverstack_cloud.region_name }} --client -f credentials.yaml
    - name: 'Bootstrap Controller'
      command: /snap/bin/juju bootstrap {{ serverstack_cloud.region_name }}/{{ serverstack_cloud.region_name }}
