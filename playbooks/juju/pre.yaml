- hosts: all
  tasks:
    - name: hack around juju's reluctance to deploy misnamed directories
      copy:
        src: "/home/ubuntu/{{ zuul.project.src_dir }}/"
        dest: "/home/ubuntu/{{ zuul.project.src_dir | replace('charm-', '') }}"
        remote_src: yes
    # setup networking
    - name: Add route to zuul-tests network
      become: true
      command: 'ip route add 172.16.0.0/16 via 10.245.164.141'
    - name: get ip
      shell: ip a | grep 10.5 | awk '{print $2}' | awk -F '/' '{print $1}'
      args:
        executable: /bin/bash
      register: ip_out
    - name: set test VIP CIDR
      set_fact:
        cidr_ext=172.16.{{ ip_out.stdout.split('.')[-1]}}.0/24
        network=172.16.{{ ip_out.stdout.split('.')[-1]}}.
    - name: 'Set test environment variables'
      set_fact:
        tox_environment:
          TEST_CIDR_EXT={{ cidr_ext }}
          TEST_CIDR_END={{ network }}.254
          TEST_GATEWAY=172.16.0.1
          TEST_NAME_SERVER=172.16.0.2
          TEST_FIP_START={{ network }}.200
          TEST_FIP_END={{ network }}.229
          TEST_FIP_RANGE="{{ network }}.200:{{ network }}.229"
          TEST_VIP00={{ network }}.230
          TEST_VIP01={{ network }}.231
          TEST_VIP02={{ network }}.232
          TEST_VIP03={{ network }}.233
          TEST_VIP04={{ network }}.234
          TEST_VIP05={{ network }}.235
          TEST_VIP06={{ network }}.236
          TEST_VIP07={{ network }}.237
          TEST_VIP08={{ network }}.238
          TEST_VIP09={{ network }}.239
          TEST_VIP10={{ network }}.240
          TEST_VIP11={{ network }}.241
          TEST_VIP12={{ network }}.242
          TEST_VIP13={{ network }}.243
          TEST_VIP14={{ network }}.244
          TEST_VIP15={{ network }}.245
          TEST_VIP16={{ network }}.246
          TEST_VIP17={{ network }}.247
          TEST_VIP18={{ network }}.248
          TEST_VIP19={{ network }}.249
          TEST_VIP20={{ network }}.250
          TEST_VIP={{ network }}.230
          TEST_VIP_RANGE="{{ network }}.230:{{ network }}.250"
    # Setup Juju
    - name: 'install crashdump'
      become: true
      snap:
        name: juju-crashdump
        classic: yes
    - name: 'install juju'
      become: true
      snap:
        name: juju
        classic: yes
    - name: Render juju clouds.yaml
      template:
        src: clouds.yaml.j2
        dest: clouds.yaml
    - name: Add cloud
      command: /snap/bin/juju add-cloud --client {{ serverstack_cloud.region_name }} clouds.yaml
    - name: 'render credentials.yaml'
      template:
        src: credentials.yaml.j2
        dest: credentials.yaml
    - name: Add credential
      command: /snap/bin/juju add-credential {{ serverstack_cloud.region_name }} --client -f credentials.yaml
    - name: 'Bootstrap Controller'
      command: /snap/bin/juju bootstrap {{ serverstack_cloud.region_name }}/{{ serverstack_cloud.region_name }}
