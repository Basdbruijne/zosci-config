- job:
    name: base
    pre-run: playbooks/base/pre.yaml
    post-run: playbooks/base/post.yaml
    roles:
      - zuul: zuul/zuul-jobs
    timeout: 1800
    attempts: 2
    nodeset:
      nodes:
        - name: bionic-small
          label: bionic-small
    secrets: &log_clouds
      - serverstack_cloud
- job:
    name: osci-lint
    description: "Run OSCI's lint task"
    parent: tox
    vars:
      tox_envlist: pep8

- job:
    name: tox-py35
    parent: tox
    description: |
      Run unit tests for a Python project under cPython version 3.5.

      Uses tox with the ``py35`` environment.

    nodeset:
      nodes:
        - name: xenial-medium
          label: xenial-medium
    vars:
      tox_envlist: py35
      python_version: 3.5

# - job:
#     name: charm-build
#     description: Build a source charm into a deployable charm
#     parent: tox
#     provides: charm
#     run: playbooks/charm/build.yaml

- job:
    name: configure-juju
    description: Sets up a Juju controller for this test environment
    parent: tox
    pre-run: playbooks/juju/pre.yaml
    cleanup-run: playbooks/juju/cleanup.yaml
    secrets:
      - serverstack_cloud

- job:
    name: func-target
    description: Run a functional test
    parent: configure-juju
    timeout: 7200
    attempts: 1 # this should be updated to two once the jobs are stable
    # dependencies:
    #   - charm-build
    semaphore: functional-test
    # as an alternate to semaphores, or along side them, we could define
    # a custom node label to use for the func jobs. This would have a potential
    # advantage of allowing us to pre-bake in cloud credentials and such in
    # addition to other node preparation we could do (snap install juju,
    # juju add-cloud, etc)
    #
    # nodeset:
    #   nodes:
    #     - name: bionic-small
    #       label: bionic-small
    vars:
      tox_envlist: func-target

- job:
    name: bionic-queens
    description: Run a functional test against bionic-queens
    parent: func-target
    vars:
      tox_extra_args: bionic-queens
- job:
    name: groovy-victoria
    description: Run a functional test against groovy-victoria
    parent: func-target
    vars:
      tox_extra_args: groovy-victoria
- job:
    name: focal-victoria
    description: Run a functional test against focal-victoria
    parent: func-target
    vars:
      tox_extra_args: focal-victoria
- job:
    name: focal-ussuri
    description: Run a functional test against focal-ussuri
    parent: func-target
    vars:
      tox_extra_args: focal-ussuri
- job:
    name: bionic-ussuri
    description: Run a functional test against bionic-ussuri
    parent: func-target
    vars:
      tox_extra_args: bionic-ussuri
- job:
    name: bionic-train
    description: Run a functional test against bionic-train
    parent: func-target
    vars:
      tox_extra_args: bionic-train
- job:
    name: bionic-stein
    description: Run a functional test against bionic-stein
    parent: func-target
    vars:
      tox_extra_args: bionic-stein
- job:
    name: bionic-rocky
    description: Run a functional test against bionic-rocky
    parent: func-target
    vars:
      tox_extra_args: bionic-rocky
- job:
    name: bionic-queens
    description: Run a functional test against bionic-queens
    parent: func-target
    vars:
      tox_extra_args: bionic-queens
- job:
    name: xenial-queens
    description: Run a functional test against xenial-queens
    parent: func-target
    vars:
      tox_extra_args: xenial-queens
- job:
    name: xenial-pike
    description: Run a functional test against xenial-pike
    parent: func-target
    vars:
      tox_extra_args: xenial-pike
- job:
    name: xenial-ocata
    description: Run a functional test against xenial-ocata
    parent: func-target
    vars:
      tox_extra_args: xenial-ocata
- job:
    name: xenial-mitaka
    description: Run a functional test against xenial-mitaka
    parent: func-target
    vars:
      tox_extra_args: xenial-mitaka
- job:
    name: trusty-mitaka
    description: Run a functional test against trusty-mitaka
    parent: func-target
    vars:
      tox_extra_args: trusty-mitaka